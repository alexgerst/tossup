<!DOCTYPE html>
<!--
	Modified from Demonstration of the TI SensorTag JavaScript library.
-->
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>TossUp</title>

	<style>
        @import 'libs/bootstrap/bootstrap.min.css';
        @import 'libs/bootstrap/bootstrap-theme.min.css;';
        @import 'libs/bootstrap-toggle/bootstrap-toggle.min.css';
		@import 'ui/css/evothings-app.css';
        @import 'ui/css/index.css';
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>

	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/evothings/tisensortag/tisensortag.js"></script>
  <script src="libs/jquery/jquery-2.2.1.min.js"></script>
  <script src="libs/bootstrap/bootstrap.min.js"></script>
  <script src="libs/bootstrap-toggle/bootstrap-toggle.min.js"></script>
</head>

<body>

	<header>
		<img class="logotype" src="ui/images/logo.png" alt="Evothings" />
	</header>

		<p id="upgradeNotice" class="hidden">
			<span class="color_softred">Please upgrade the firmware of your SensorTag.</span>
		</p>


    <div class="container-fluid">
      <div class="col-xs-12">
        <div class="row" style="padding-top:25px;">
          <div class="col-xs-4" style="padding-top:25px;">
            <input id="connectCheckbox" type="checkbox" data-toggle="toggle">
          </div>
          <div class="col-xs-4">
            <h2 style="padding-top: 20px;">Height</h2>
          </div>
          <div class="col-xs-4">
            <img src="ui/images/list.png" class="btn btn-default" style= height="60" width="60">
          </div>
        </div>
        <div class="row centered">
          <h1>
            <span id="heightField" class="measurement">437</span>
            <!--<span class="units">ft.</span>-->
          </h1>
        <div class="row centered">
          <h2>Spin</h2>
        </div>
        <div class="row centered">
          <h1>
            <span id="spinField" class="measurement">441</span>
            <!--<span class="units">&deg;/s</span>-->
          </h1>
        </div>
        <div class="row centered">
          <div class="startStop centered" id="startButton" onClick="startButtonPress();">
            <p id="buttonText">Start</p>
          </div>
        </div>
      </div>
    </div>

	<script>
	// SensorTag object
	var sensortag

    // SensorTag connection variables
    var attemptToConnect = false    // Whether or not the user is currently attempting to connect
    var connected = false           // Whether or not a SensorTag is currently connected
    var connecting = false          // Whether or not the app is actively trying to connect
    var readTimeout = null          // Timeout for reading characteristics

    setInterval(checkConnection, 500)

    function checkConnection()
    {
        attemptToConnect = document.getElementById('connectCheckbox').checked;

        if (sensortag && sensortag.device)
        {
            readTimeout = setTimeout(
                function() {
                    connected = false
                },
                400
            )

            sensortag.device.readCharacteristic(
                "00002a24-0000-1000-8000-00805f9b34fb",
                function() { 
                    if (readTimeout != null) {
                        clearTimeout(readTimeout)
                    }
                    connected = true
                },
                function() {
                    connected = false
                }
            )
        }
        else
        {
            connected = false
        }

        if (attemptToConnect)
        {
            if (connected)
            {
                // set bluetooth-connected.png
                console.log('checkConnection(): bluetooth-connected')
            }
            else
            {
                // set bluetooth-connecting.png
                console.log('checkConnection(): bluetooth-connecting')
                if (!connecting)
                {
                    connecting = true
                    setTimeout(
                        function() {
                            connecting = false
                        },
                        5000
                    )
                    connect()
                }
            }
        }
        else
        {
            // set bluetooth-off.png
            console.log('checkConnection(): bluetooth-off')
            disconnect()
        }
    }

  function startButtonPress()
  {
    start = document.getElementById('startButton');
    start.setAttribute('id', 'stopButton');
    document.getElementById('buttonText').innerHTML = 'Stop';
    start.setAttribute('onClick', 'stopButtonPress();');
  }

  function stopButtonPress()
  {
    stop = document.getElementById('stopButton');
    stop.setAttribute('id', 'startButton');
    document.getElementById('buttonText').innerHTML = 'Start';
    stop.setAttribute('onClick', 'startButtonPress();');
  }

	function initialiseSensorTag()
	{
		// Create SensorTag CC2650 instance.
		sensortag = evothings.tisensortag.createInstance(
			evothings.tisensortag.CC2650_BLUETOOTH_SMART)

		//
		// Here sensors are set up.
		//
		// If you wish to use only one or a few sensors, just set up
		// the ones you wish to use.
		//
		// First parameter to sensor function is the callback function.
		// Several of the sensors take a millisecond update interval
		// as the second parameter.
		//

		sensortag.temperatureOff()
		sensortag.humidityOff()
		sensortag.luxometerOff()
		sensortag
			.statusCallback(statusHandler)
			.errorCallback(errorHandler)
			.keypressCallback(keypressHandler)
			.barometerCallback(barometerHandler, 1000)
			.accelerometerCallback(accelerometerHandler, 1000)
			.magnetometerCallback(magnetometerHandler, 1000)
			.gyroscopeCallback(gyroscopeHandler, 1000)
	}

	function connect()
	{
        if (sensortag != null)
        {
		    sensortag.connectToNearestDevice()
        }
	}

	function disconnect()
	{
        if (sensortag != null)
        {
		    sensortag.disconnectDevice()
        }
	}

	function statusHandler(status)
	{
		if ('DEVICE_INFO_AVAILABLE' == status)
		{
			// Show a notification about that the firmware should be
			// upgraded if the connected device is a SensorTag CC2541
			// with firmware revision less than 1.5, since this the
			// SensorTag library does not support these versions.
			var upgradeNotice = document.getElementById('upgradeNotice')
			if ('CC2541' == sensortag.getDeviceModel() &&
				parseFloat(sensortag.getFirmwareString()) < 1.5)
			{
				upgradeNotice.classList.remove('hidden')
			}
			else
			{
				upgradeNotice.classList.add('hidden')
			}

			// Show device model and firmware version.
			// displayValue('DeviceModel', sensortag.getDeviceModel())
			// displayValue('FirmwareData', sensortag.getFirmwareString())
		}
        if ('CONNECTED' == status)
        {
            connected = true
        }
        if ('EASYBLE_ERROR_DISCONNECTED' == status)
        {
            connected = false
        }

		displayValue('StatusData', status)
	}

	function errorHandler(error)
	{
		console.log('Error: ' + error)

		if (evothings.easyble.error.DISCONNECTED == error)
		{
			resetSensorDisplayValues()
		}
		else
		{
			displayValue('StatusData', 'Error: ' + error)
		}
	}

	function resetSensorDisplayValues()
	{
		// Clear current values.
		var blank = '[Waiting for value]'
		displayValue('StatusData', 'Press Connect to find a SensorTag')
		// displayValue('DeviceModel', '?')
		// displayValue('FirmwareData', '?')
		displayValue('KeypressData', blank)
		displayValue('AccelerometerData', blank)
		displayValue('MagnetometerData', blank)
		displayValue('BarometerData', blank)
		displayValue('GyroscopeData', blank)
	}

	function keypressHandler(data)
	{
		// Update the value displayed.
		var string = 'raw: 0x' + bufferToHexStr(data, 0, 1)
		displayValue('KeypressData', string)
	}

	function accelerometerHandler(data)
	{
		// Calculate the x,y,z accelerometer values from raw data.
		var values = sensortag.getAccelerometerValues(data)
		var x = values.x
		var y = values.y
		var z = values.z

		// Prepare the information to display.
		string =
			'x: ' + (x >= 0 ? '+' : '') + x.toFixed(5) + 'G<br/>' +
			'y: ' + (y >= 0 ? '+' : '') + y.toFixed(5) + 'G<br/>' +
			'z: ' + (z >= 0 ? '+' : '') + z.toFixed(5) + 'G<br/>'

		// Update the value displayed.
		displayValue('AccelerometerData', string)
	}

	function magnetometerHandler(data)
	{
		// Calculate the magnetometer values from raw sensor data.
		var values = sensortag.getMagnetometerValues(data)
		var x = values.x
		var y = values.y
		var z = values.z

		// Prepare the information to display.
		string =
			'x: ' + (x >= 0 ? '+' : '') + x.toFixed(5) + '&micro;T <br/>' +
			'y: ' + (y >= 0 ? '+' : '') + y.toFixed(5) + '&micro;T <br/>' +
			'z: ' + (z >= 0 ? '+' : '') + z.toFixed(5) + '&micro;T <br/>'

		// Update the value displayed.
		displayValue('MagnetometerData', string)
	}

	function barometerHandler(data)
	{
		// Calculate pressure from raw sensor data.
		var values = sensortag.getBarometerValues(data)
		var pressure = values.pressure

		// Prepare the information to display.
		string =
			'Pressure: ' + pressure.toPrecision(5) + ' mbar<br/>'

		// Update the value displayed.
		displayValue('BarometerData', string)
	}

	function gyroscopeHandler(data)
	{
		// Calculate the gyroscope values from raw sensor data.
		var values = sensortag.getGyroscopeValues(data)
		var x = values.x
		var y = values.y
		var z = values.z

		// Prepare the information to display.
		string =
			'x: ' + (x >= 0 ? '+' : '') + x.toFixed(5) + '<br/>' +
			'y: ' + (y >= 0 ? '+' : '') + y.toFixed(5) + '<br/>' +
			'z: ' + (z >= 0 ? '+' : '') + z.toFixed(5) + '<br/>'

		// Update the value displayed.
		displayValue('GyroscopeData', string)
	}

	function displayValue(elementId, value)
	{
		document.getElementById(elementId).innerHTML = value
	}

	/**
	 * Convert byte buffer to hex string.
	 * @param buffer - an Uint8Array
	 * @param offset - byte offset
	 * @param numBytes - number of bytes to read
	 * @return string with hex representation of bytes
	 */
	function bufferToHexStr(buffer, offset, numBytes)
	{
		var hex = ''
		for (var i = 0; i < numBytes; ++i)
		{
			hex += byteToHexStr(buffer[offset + i])
		}
		return hex
	}

	/**
	 * Convert byte number to hex string.
	 */
	function byteToHexStr(d)
	{
		if (d < 0) { d = 0xFF + d + 1 }
		var hex = Number(d).toString(16)
		var padding = 2
		while (hex.length < padding)
		{
			hex = '0' + hex
		}
		return hex
	}

	document.addEventListener(
		'deviceready',
		function() { evothings.scriptsLoaded(initialiseSensorTag) },
		false)
	</script>

</body>

</html>
